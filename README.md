# ovlshell

`ovlshell` launches a **private, copy-on-write workspace** derived from the current directory (or the root of your Git repository).  

It creates a temporary overlay (Linux) or APFS clone (macOS), drops you into your preferred shell (`$SHELL`), and lets you work without touching the original files.  
When you exit, you can choose to keep or delete the temporary workspace.

---

## Features

- **Private changes**: start from a common seed, all edits go into an isolated layer.
- **Git-aware**: if you are inside a Git repo, the repo root is used as the seed; otherwise it uses the current directory.
- **Cross-platform**:  
  - **Git repositories**: uses `git worktree` for instant workspace creation (~0.1s regardless of repo size)
  - **Linux non-git**: uses [`fuse-overlayfs`](https://github.com/containers/fuse-overlayfs) (rootless) or kernel OverlayFS (if root)
  - **macOS non-git**: uses hardlink-based copy-on-write (fast, enterprise-safe)
- **Shell integration**: starts `$SHELL` (fallbacks: `/bin/bash`, `/bin/sh`), passing through your environment.
- **Consistent paths**: if you start from a subdirectory of the seed, you land in the equivalent subdirectory inside the workspace.
- **Cleanup prompt**: after exit, you can confirm whether to delete or keep the workspace for inspection.

---

## Installation

Copy the script into your `$PATH`:

```bash
curl -o ~/bin/ovlshell https://example.com/ovlshell.sh
chmod +x ~/bin/ovlshell
```

### Dependencies

#### Git repositories (Linux & macOS)

No extra dependencies required. Uses `git worktree` for instant workspace creation (~0.1s regardless of repository size).

#### Linux non-git directories

Install `fuse-overlayfs` (recommended, works rootless):

```bash
sudo apt install -y fuse-overlayfs  # Ubuntu/Debian
sudo dnf install -y fuse-overlayfs  # Fedora
```

Or run as root with kernel OverlayFS enabled.

#### macOS non-git directories

APFS filesystem (default on modern macOS). Uses hardlink-based copy-on-write for fast setup. No extra packages required and enterprise-safe (no kernel extensions).


## Usage

ovlshell [-n name] [-c "command"]

Options:

```
-n name — optional session name. If omitted, a Docker-style random name is generated (e.g. brave_curie).
-c "command" — run a command non-interactively in the private workspace, then exit. Without -c, you get an interactive shell.
-h — show help.
```

### Examples

Interactive shell


```sh
cd myproject/subdir
ovlshell
```

This will:

    - detect myproject/ as the Git repo root,
    - create an overlay workspace under /tmp/ovl-brave_curie/,
    - mount it, then open your shell in /tmp/ovl-brave_curie/merged/subdir.

Exit the shell, and you’ll be asked whether to delete the session directory.
Run a command

```
ovlshell -c "make test"
```

Runs make test inside the private workspace, then prompts for cleanup.
Inspect changes

If you choose not to delete, you can inspect what changed:

- **Git worktree (Linux & macOS)**: changes are tracked by git in the worktree.
- **Linux overlay**: look in upper/ inside the session dir.
- **macOS hardlink**: modified files break hardlinks and exist in merged/.

Session layout

**Git worktree (Linux & macOS):**
```
/tmp/ovl-brave_curie/
└── merged/   # git worktree checkout (instant)
```

**Linux overlay:**
```
/tmp/ovl-brave_curie/
├── upper/    # private changes
├── work/     # overlay bookkeeping
└── merged/   # union view (your shell runs here)
```

**macOS hardlink:**
```
/tmp/ovl-brave_curie/
└── merged/   # hardlinked files + modifications
```

### Environment variables

Inside the shell, a few helper variables are set:

```sh
OVL_NAME — session name
OVL_SEED — original seed path
OVL_SESSION — session root under $TMPDIR
OVL_WORKDIR — the merged working directory
```

## Why?

Being able to run multiple AI agents in the same repository, without then
interfering with each others, without needing to create multiple worktrees or
other manual fiddling.

## License

MIT — do what you like, but no warranty.

## Credits

The original code and README were generated by ChatGPT5. macOS reliability improvements and hardlink-based copy-on-write implementation by Claude (Anthropic). Tested and iterated upon manually — use at your own risks.
